name: Generate ASP.NET Core API and C# Client

on:
  push:
    paths:
      - "factset_estimates_api-v2.yml"
      - ".github/workflows/openapi-windows.yml"
  workflow_dispatch:

permissions:
  contents: write  # required to push commits and create PRs

jobs:
  generate:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install OpenAPI Generator CLI
        run: npm install -g @openapitools/openapi-generator-cli
        shell: pwsh

      # ----------------------------------------
      # 1. GENERATE ASP.NET CORE API SERVER
      # ----------------------------------------
      - name: Generate ASP.NET Core API
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force generated-api -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path generated-api
          
          openapi-generator-cli generate `
            -i factset_estimates_api-v2.yml `
            -g aspnetcore `
            -o generated-api `
            --additional-properties=packageName=FactsetEstimatesApi

      - name: Fix invalid escape sequences in generated C# API files
        shell: pwsh
        run: |
          cd generated-api
          Get-ChildItem -Path . -Recurse -Include *.cs -File |
            ForEach-Object {
              $text = Get-Content $_.FullName -Raw
              $text = $text -replace '\\&quot;', '\"'
              Set-Content -Path $_.FullName -Value $text
            }

      # ----------------------------------------
      # 2. BUILD (validate)
      # ----------------------------------------
      - name: Build ASP.NET Core API
        run: dotnet build generated-api/src/FactsetEstimatesApi/FactsetEstimatesApi.csproj
        shell: pwsh

      # ----------------------------------------
      # 3. GENERATE C# CLIENT
      # ----------------------------------------
      - name: Generate C# API Client
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force generated-client -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path generated-client

          openapi-generator-cli generate `
            -i factset_estimates_api-v2.yml `
            -g csharp `
            -o generated-client `
            --additional-properties=packageName=FactsetEstimatesClient

      # ----------------------------------------
      # 4. RUN .NET TESTS
      # ----------------------------------------
      - name: Run .NET Tests
        shell: pwsh
        run: |
          dotnet test generated-client/src/FactsetEstimatesClient.Test/FactsetEstimatesClient.Test.csproj --no-build --verbosity normal

      # ----------------------------------------
      # 5. PUSH GENERATED CODE TO BRANCH
      # ----------------------------------------
      - name: Push Generated Code to Branch
        shell: pwsh
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"

          # Create a branch for generated code
          $branch = "generated-api-client"
          git checkout -b $branch

          # Add generated folders
          git add generated-api generated-client

          # Commit changes
          git commit -m "Regenerate ASP.NET Core API and C# client via workflow" -a -m "Auto-generated code" || Write-Host "No changes to commit"

          # Push to the branch
          git push --set-upstream origin $branch --force

      # ----------------------------------------
      # 6. Create Pull Request (optional)
      # ----------------------------------------
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: generated-api-client
          title: "Regenerate ASP.NET Core API and C# client"
          body: "Automated PR generated by GitHub Actions to update the API server and client."
          labels: "auto-generated"
